<script type="text/discourse-plugin" version="0.8.20">
  const { iconNode } = require("discourse-common/lib/icon-library");

  const customHeaderLinks = settings.Custom_header_links;
  const user = api.getCurrentUser() || {};
  const groups = user.groups || [];
  var isMember = false;
  
  // Use Discourse.SiteSettings instead of hard coded group name "members"
  const groupsWithAccessToMemberDirectory = [
    Discourse.SiteSettings.libra_discourse_member_directory_group_name,
    ...(Discourse.SiteSettings.libra_discourse_member_directory_groups_with_member_directory_access || '').split('|')
  ].filter(function(groupName) { return groupName.length > 0; });
  if (groups.filter(function(g) { return groupsWithAccessToMemberDirectory.includes(g.name); }).length > 0) {
    isMember = true;
  }

  if (!customHeaderLinks.length) return;

  const h = require("virtual-dom").h;
  const memberLinks = [];
  const publicLinks = [];

  customHeaderLinks.split("|").map(i => {
    const seg = $.map(i.split(","), $.trim);
    const linkText = seg[0];
    const linkTitle = seg[1];
    const linkHref = seg[2];
    const userClass = `.${seg[3]}`;
    const linkTarget = seg[4] === "self" ? "" : "_blank";
    const keepOnScrollClass = seg[5] === "keep" ? ".keep" : "";
    const linkClass = `.${linkText.trim().toLowerCase().replace(/\s/gi, '-')}-nav-item`;
    
    if (userClass === '.members' || userClass === '.both') {
        memberLinks.push(
            h(
              `li${userClass}${keepOnScrollClass}${linkClass}`,
              h(
                "a.nav-link",
                {
                  title: linkTitle,
                  href: linkHref,
                  target: linkTarget
                },
                linkText
              )
            )
        );
    }
    
    if (userClass === '.public' || userClass === '.both') {
        publicLinks.push(
            h(
              `li${userClass}${keepOnScrollClass}${linkClass}`,
              h(
                "a.nav-link",
                {
                  title: linkTitle,
                  href: linkHref,
                  target: linkTarget
                },
                linkText
              )
            )
        );
    }
  });

  api.decorateWidget("header-buttons:before", helper => {
      if (isMember) {
       return helper.h(
          'ul.nav-link-container', [
              helper.h('li.nav-link-title.members', [
                helper.h('a.nav-link', {
                    href:'/c/member-portal', 
                    text:'Member Portal',
                    target:'_self'
                }) 
              ]),
              memberLinks,
              helper.h('li.more', [
                helper.h('a.nav-link', {
                    text:'More',
                }, iconNode('angle-down')),
                helper.h('ul'),
              ]),
          ]
        );   
      } 
      else {
        return helper.h(
          'ul.nav-link-container', [
              helper.h('li.nav-link-title.public', [
                helper.h('a.nav-link', {
                    href:'https://developers.libra.org/', 
                    text:'Developers',
                    target:'_self'
                }) 
              ]),
              publicLinks,
              helper.h('li.more', [
                helper.h('a.nav-link', {
                    text:'More',
                }, iconNode('angle-down')),
                helper.h('ul'),
              ]),
          ]
        ); 
      }
  });

  api.decorateWidget("home-logo:after", helper => {
    let titleVisible = helper.attrs.minimized;
    if (titleVisible) {
      $(".d-header").addClass("hide-menus");
    } else {
      $(".d-header").removeClass("hide-menus");
      if ($(window).width() > 600) {
        var calcTimeout = setTimeout(calcWidth, 50);
      }
    }
  });

  api.decorateWidget("home-logo:before", helper => {
    return helper.h('span.nav-link-trigger', [
        iconNode('ellipsis-v'),
        iconNode('times')
    ]);
  });
  
  api.onPageChange(() => {  
    setActiveNav();
  });

  api.changeWidgetSetting('home-logo', 'href', 'https://developers.libra.org/')


</script>