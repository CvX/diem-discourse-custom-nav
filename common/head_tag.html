<script>
  const interceptClick = require('discourse/lib/intercept-click').default;

  $(document).ready(function() {
    addBackToTopClickFunctionality();
  });

  function addBackToTopClickFunctionality() {
    const backToTop = $('.d-header #back-to-top');
    backToTop.on('click', function(event) {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }

  (function() {
    let isMainNavClick = false;
    let isSubNavClick = false;
    let isDesktopSubNavClick = false;

    $(document).ready(function() {
      const mainNavToggles = document.querySelectorAll('.main-nav .mobile.main-nav-trigger');
      const mainNav = document.querySelector('.main-nav .navigationWrapper.navigationSlider');
      const subNavToggles = document.querySelectorAll('#SubNav .mobile.sub-nav-trigger');
      const subNav = document.querySelector('#SubNav .navigationWrapper.navigationSlider');

      const $desktopSubNavToggles = $('#SubNav .desktop-sub-nav-toggle');
      const $desktopSubNav = $('#SubNav .sub-sub-nav-links');

      function addClickHandlersToMainNavTriggers() {
        window.addEventListener('click', function() {
          if (!isMainNavClick) {
            closeNav(mainNav, mainNavToggles, 'mobile-hidden');
          }
          isMainNavClick = false;
        });
        if (mainNav) {
          mainNav.addEventListener('click', function(event) {
            event.stopPropagation();
          });
        }

        addClickHandlersToMobileNavToggles(mainNavToggles, mainNav, true, false);
      }

      function addClickHandlersToSubNavTriggers() {
        window.addEventListener('click', function() {
          if (!isSubNavClick) {
            closeNav(subNav, subNavToggles, 'mobile-hidden');
          }
          isSubNavClick = false;
        });
        if (subNav) {
          subNav.addEventListener('click', function(event) {
            event.stopPropagation();
          });
        }
        addClickHandlersToMobileNavToggles(subNavToggles, subNav, false, true);
      }

      function addClickHandlersToDesktopSubNavToggles() {
        console.log('addClickHandlersToDesktopSubNavToggles');
        window.addEventListener('click', function() {
          if (!isDesktopSubNavClick) {
            closeNav($desktopSubNav[0], $desktopSubNavToggles.toArray(), 'mobile');
          }
          isDesktopSubNavClick = false;
        });
        if ($desktopSubNav.length) {
          $desktopSubNav.on('click', function(event) {
            console.log('clicked Desktop toggle');
            event.stopPropagation();
            event.preventDefault();
          });
        }
        addClickHandlersToDesktopNavToggles($desktopSubNavToggles, $desktopSubNav);
      }

      function addNavLinkClickIntercept() {
        $('#unified-nav a').on('click', function(e) {
          // Uses Discourse to navigate on internal links,
          // not full page loads

          if ($(e.target).closest('.desktop-sub-nav-toggle').length === 0) {
            interceptClick(e);
            closeNav($desktopSubNav, $desktopSubNavToggles, 'mobile');
          }
          closeNav(mainNav, mainNavToggles, 'mobile-hidden');
          closeNav(subNav, subNavToggles, 'mobile-hidden');
        });
      }

      addClickHandlersToMainNavTriggers();
      addClickHandlersToSubNavTriggers();
      addClickHandlersToDesktopSubNavToggles();
      addNavLinkClickIntercept();
    });

    function addClickHandlersToMobileNavToggles(navToggles, nav, _isMainNavClick, _isSubNavClick) {
      navToggles.forEach(function(node) {
        node.addEventListener('click', function() {
          isMainNavClick = _isMainNavClick;
          isSubNavClick = _isSubNavClick;
          navToggles.forEach(function(toggle) {
            toggleVisibility(toggle, 'mobile-hidden');
          });
          toggleVisibility(nav, 'mobile-hidden');
        });
      });
    }

    function addClickHandlersToDesktopNavToggles($navToggles, $nav) {
      console.log('addClickHandlersToDesktopNavToggles', $navToggles, $nav);
      $navToggles.each(function(i, node) {
        $(node).on('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          $navToggles.each(function(i, toggle) {
            toggleVisibility(toggle, 'mobile');
          });
          toggleVisibility($nav[0], 'mobile');
        });
      });
    }

    function toggleVisibility(node, className) {
      if (node) {
        node.classList.toggle(className);
      }
    }

    function closeNav(nav, navToggles, className) {
      navToggles.forEach(function(toggle) {
        if (toggle.classList.contains('trigger-open')) {
          toggle.classList.remove(className);
        } else {
          toggle.classList.add(className);
        }
      });
      if (nav) {
        nav.classList.add(className);
      }
    }
  })();
</script>
