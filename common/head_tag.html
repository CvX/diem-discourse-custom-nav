<script>
  const interceptClick = require('discourse/lib/intercept-click').default;

  $(document).ready(function() {
    addBackToTopClickFunctionality();
  });

  function addBackToTopClickFunctionality() {
    const backToTop = $('.d-header #back-to-top');
    backToTop.on('click', function(event) {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }

  (function() {
    let isMainNavClick = false;
    let isSubNavClick = false;

    $(document).ready(function() {
      const mainNavToggles = document.querySelectorAll('.main-nav .mobile.main-nav-trigger');
      const mainNav = document.querySelector('.main-nav .navigationWrapper.navigationSlider');
      const subNavToggles = document.querySelectorAll('#SubNav .mobile.sub-nav-trigger');
      const subNav = document.querySelector('#SubNav  .navigationWrapper.navigationSlider');
      function addClickHandlersToMainNavTriggers() {
        window.addEventListener('click', function() {
          if (!isMainNavClick) {
            closeNav(mainNav, mainNavToggles);
          }
          isMainNavClick = false;
        });
        if (mainNav) {
          mainNav.addEventListener('click', function(event) {
            event.stopPropagation();
          });
        }

        addClickHandlersToNavToggles(mainNavToggles, mainNav, true, false);
      }

      function addClickHandlersToSubNavTriggers() {
        window.addEventListener('click', function() {
          if (!isSubNavClick) {
            closeNav(subNav, subNavToggles);
          }
          isSubNavClick = false;
        });
        if (subNav) {
          subNav.addEventListener('click', function(event) {
            event.stopPropagation();
          });
        }
        addClickHandlersToNavToggles(subNavToggles, subNav, false, true);
      }

      function addNavLinkClickIntercept() {
        $('#unified-nav a').on('click', function(e) {
          console.log('intercepting');
          // Uses Discourse to navigate on internal links,
          // not full page loads
          interceptClick(e);
          closeNav(mainNav, mainNavToggles);
          closeNav(subNav, subNavToggles);
        });
      }

      addClickHandlersToMainNavTriggers();
      addClickHandlersToSubNavTriggers();
      addNavLinkClickIntercept();
    });

    function addClickHandlersToNavToggles(navToggles, nav, _isMainNavClick, _isSubNavClick) {
      navToggles.forEach(function(node) {
        node.addEventListener('click', function() {
          isMainNavClick = _isMainNavClick;
          isSubNavClick = _isSubNavClick;
          navToggles.forEach(function(toggle) {
            toggleVisibility(toggle);
            toggle.classList.contains('trigger-open');
          });
          toggleVisibility(nav);
        });
      });
    }

    function toggleVisibility(node) {
      if (node) {
        node.classList.toggle('mobile-hidden');
      }
    }

    function closeNav(nav, navToggles) {
      navToggles.forEach(function(toggle) {
        if (toggle.classList.contains('trigger-open')) {
          toggle.classList.remove('mobile-hidden');
        } else {
          toggle.classList.add('mobile-hidden');
        }
      });
      if (nav) {
        nav.classList.add('mobile-hidden');
      }
    }
  })();
</script>
